## 實做文章通知

#### 目錄

- 介紹
- 流程圖
- 註冊pusher帳號
- 安裝puser套件
- 修改env檔案
- config檔案
- Redis
- 安裝laravel echo與pusher channels
- 實做
- 問題

#### 介紹

- laravel notification

  是一個發送通知的類別，可以很多種傳輸方式，例如：emil、database、推播等等，可以用`via()`來設定多種傳輸方式

- laravel broadcast

  是laravel的推播系統，分別有兩種第三方平台服務pusher、redis，透過Event事件將推播資料，傳送到服務的channel，要設定好channel的資料，確保收到推播資料

- laravel echo

  透過laravel broadcast的兩種服務，pusher、redis設定js，在畫面上接收服務的channel，傳過來的推播資料，並且將資料顯示在畫面上，做到即時通知的功能
  
  **laravel echo與broadcast有什麼關係?**
  
  laravel echo是在前端畫面，接收到pusher或Redis的channel，傳過來的推播資料，broadcast則是在controller發送推播資料，給pusher或Redis，一個發送，一個接收

以下範例 用laravel notification與broadcast新增一篇文章時，通知user有新的文章可以閱讀

流程圖分別是新增文章、新增文章發通知、刪除文章、新增留言、閱讀文章、已閱讀通知、已閱讀全部、點選通知訊息、發通知的系統流程

![notice1](C:\xampp\htdocs\markdown_note\assets\images\addArticle.png)

![notice1](C:\xampp\htdocs\markdown_note\assets\images\addArticleSend.png)

![notice1](C:\xampp\htdocs\markdown_note\assets\images\deleteArticle.png)

![notice1](C:\xampp\htdocs\markdown_note\assets\images\addComment.png)

![notice1](C:\xampp\htdocs\markdown_note\assets\images\readArticle.png)

![readNotification](C:\xampp\htdocs\markdown_note\assets\images\readNotification.png)

![sendNotificationAll](C:\xampp\htdocs\markdown_note\assets\images\sendNotificationAll.png)

![getNotification](C:\xampp\htdocs\markdown_note\assets\images\getNotification.png)

![notice1](C:\xampp\htdocs\markdown_note\assets\images\notice.png)

![broadcast](C:\xampp\htdocs\markdown_note\assets\images\broadcast.png)

![notice2](C:\xampp\htdocs\markdown_note\assets\images\notice2.png)

![pusher1](C:\xampp\htdocs\markdown_note\assets\images\pusher1.png)

![pusher2](C:\xampp\htdocs\markdown_note\assets\images\pusher2.png)

![pusher3](C:\xampp\htdocs\markdown_note\assets\images\pusher3.png)

#### 註冊[pusher](https://pusher.com/)帳號

註冊完登入之後，在channel點選Manage，再點選Create App來建立頻道

![channel](C:\xampp\htdocs\markdown_note\assets\images\channel.png)

建立完之後，點選剛建立的channel，在點選Getting Started，會有laravel使用pusher的步驟

#### 安裝pusher套件

```bash
composer require pusher/pusher-php-server
```

#### 修改env檔案

```bash
PUSHER_APP_ID=pusher的app id
PUSHER_APP_KEY=pusher的app key
PUSHER_APP_SECRET=pusher的app secret
PUSHER_APP_CLUSTER=config/broadcasting options的cluster
BROADCAST_DRIVER=pusher

MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
```

#### config檔案

在config/broadcast.php，新增options

```php
'options' => [
  'cluster' => 'ap3',
  'useTLS' => true
],
```

#### Redis

如果用Redis的話，要先安裝套件

```bash
composer require predis/predis
```

修改env檔案

```bash
PUSHER_APP_CLUSTER=redis
```

redis安裝stock.io來啟動

```bash
npm install --save socket,io-clent
```

使用stock.io的話，需要安裝laravel-echo-server

```bash
npm install laravel-echo-server
```

安裝完之後要執行初始化，之後在啟動

```bash
laravel-echo-server init
laravel-echo-server start
```

#### 安裝laravel echo與pusher channels 

```
npm install --save laravel-echo pusher-js
```

在resources/js/bootstrap.js，新增下面這幾行

```javascript
import Echo from 'laravel-echo';

window.Pusher = require('pusher-js');

window.Echo = new Echo({
    broadcaster: 'pusher',
    key: process.env.MIX_PUSHER_APP_KEY,
    cluster: process.env.MIX_PUSHER_APP_CLUSTER,
    encrypted: true
});
------------------------------------------------
//如果是用socket.io-client換成下面這幾行

window.io = require('socket.io-client');

window.Echo = new Echo({
    broadcaster: 'socket.io',
    host: window.location.hostname + ':6001'
});
```

#### 實做laravel

1. 在config/app.php的providers，新增下面這行

   ```php
   App\Providers\BroadcastServiceProvider
   ```

2. **建立Events與Listeners的class做關聯**

   在app/Providers/EventServiceProvider.php，例如：App\Events\AddArticles.php與App\Listeners\SendArticlesUser.php

   ```php
    protected $listen = [
        'App\Events\AddArticles' => [
            'App\Listeners\SendArticlesUser',
        ],
        'App\Events\AddComment' => [
            'App\Listeners\SendArticlesUser',
        ],
        'App\Events\DeleteArticles' => [
            'App\Listeners\SendArticlesUser',
        ],
   ]
   ```

   執行指令建立

   ```bash
   php artisan event:generate
   ```

   generate是可以自動建立event和listeners做連接，自動建立AddArticles、SendArticlesUser

   執行建立notifition

   ```bash
   php artisan make:notification NewNotification
   ```

   App/User.php要補上use Notifiable，在controller使用user model的時候，可以拿Notifiable table的資料

   ```php
   use Notifiable;
   ```

3. **建立Pusher的Events**

   ```bash
   php artisan make:event SeenMessage
   ```

   要補上implements ShouldBroadcast，用events做推播

4. **controller觸發事件**

   顯示文章列表

   ```php
   //新增ArticlesController，在使用event執行App\Events\Articles，新增文章或刪除文章時做通知
   public function showAdd(Request $request)
   {
       //取得userid，進入新增文章畫面
       $userId = $request->userId;
   
       return view('add', [
           'userId' => $userId,
       ]);
   }
   
   public function showAritcles(Request $request)
   {
       //取得目前登入的userId,在從DB找user有收到哪些通知，預設畫面顯示10則通知訊息
       $id = Auth::id();
       $user = \App\User::where('id', '=', $id)->first();
       $count = 10;
       $notifications = $user->notifications->take($count);
       $datetime = Carbon::now()->setTimezone('Asia/Taipei')->toDateTimeString();
       $notificationsArray = [];
       
       //每筆通知資料，組array傳到畫面上呈現，分別有id、title、status、read、該通知是否已超過三天
       foreach($notifications as $notification){
           $array = [ 
               'id' => $notification->id,
               'title' => $notification->data['title'],
               'status' => $notification->data['status'],
               'articlesId' => $notification->data['articlesId'],
               'read' => $notification->read(),
               'notThreeDay' => ceil((strtotime($notification->created_at) - strtotime($datetime))/86400) < 3
           ];
           array_push($notificationsArray, $array);
        }
       
        //取所有文章資料
        $articles = Articles::orderBy('id')->get();
       
        $data = [
            'notifications' => $notificationsArray,
            'notificationsCount' => $count,
            'articles' => $articles,
            'userId' => $id,
            'datetime' => $datetime,
        ];
   
        return view('articles', $data);
   }
   ```

   ```php
   public function addArticles()
   {
       //新增一篇文章，將標題、內容、作者id新增到db裡
       $articles = new Articles();
       $articles->title = $request->InputTitle;
       $articles->content = $request->InputContent;
       $articles->author_id = $request->userId;
       $articles->save();
       
       //判斷新增後的title和id不為null或空白
       if($title != null && $title != '' && $id != null && $id != ''){
           foreach (\App\User::cursor() as $user) {
               event(new AddArticles($user, '新文章:' . $title, $id));
           };
       }
       
        return redirect()->route('showAritcles');
   }
   ```

   ```php
   public function readArticles(Request $request)
   {
       //讀取文章id與user id
       $id = $request->id;
       $userId = $request->userId;
       $status = 'success';
       try{
           //執行已閱讀文章，要更新read_at
           $this->readNotifications($id, $userId);
       }catch(Exception $e){
           $status = 'error';
       }
       //回傳更新狀態
       return $status;
   }
   
   public function readNotifications($id, $userId)
   {
       //搜尋user有哪些通知
       $user = User::where('id', '=', $userId)->first();
       //建立user的Notification物件
       $data = $user->unreadNotifications;
           
       if($id != ''){
           //已閱讀單筆通知
           $notification = $data::where('id', '=', $id)->first();
           $notification->markAsRead();
        }else{
           //已閱讀全部的通知
           $data->markAsRead();
        }
   }
   ```

   ```php
   public function showArticleContent(Request $request)
   {
       //從畫面取得文章id、userId、通知id、
       $id = $request->id;
       $userId = $request->userId;
       $notificationId = $request->notificationId;
       $isAdd = $request->isAdd;
       $isRead = $request->isRead;
       
   	if($notificationId != null && $userId != null && $isRead == 'N'){
           //點選後直接做已閱讀
           $this->readNotifications($notificationId, $userId);
       }
   
   }
   ```

   ```php
   public function sendNotification(){
       $articles= Articles::where('online_date', '=', $date)->get();
       foreach($articles as $article){    
           $title = $article->title;
           $id = $article->id;
           $sendNotice = $article->send_notice;
   
           //確認該文章要發通知，就發給所有的user
           if($sendNotice == 'Y'){
               foreach (\App\User::cursor() as $user) {
                   event(new AddArticles($user, '新文章:' . $title, $id));
               };
            } 
       }
   } 
   ```

   ```php
   public function deleteArticles(Request $request)
   {
       $options = array(
           'cluster' => env('PUSHER_APP_CLUSTER'),
           'encrypted' => true
       );
           
       set_time_limit(1200);
   
       $pusher = new Pusher(
           env('PUSHER_APP_KEY'),
           env('PUSHER_APP_SECRET'),
           env('PUSHER_APP_ID'),
           $options
       );
       
       foreach (\App\User::cursor() as $user) {
           event(new DeleteArticles($user, $title, $id));
   
           $data['message'] = '您有一篇新訊息【' . $title. '】';
           $data['user'] = $user;
           $pusher->trigger('article-channel', 'App\\Events\\SendMessage', $data);
       };
   }
   ```


   ```php
   //新增CommentController，在使用event執行App\Events\Articles，新增留言時做通知
   public function editComment(Request $request)
   {
       $articleId = $request->articleId;
       $userId = $request->userId;
   
       $articles = Articles::where('id', '=', $articleId)->first();
       $authorId = $articles->author_id;
       $title = $articles->title;
       $userName = User::where('id', '=', $userId)->first()->name;
       $authorName = User::where('id', '=', $authorId)->first()->name;
   }
   ```

   ```php
   public function addComment(Request $request)
   {
       $user = User::WhereIn('id', $idArray)->get();
       event(new AddArticles($user,  $title . '有一則新留言', $articleId, 'comment'));
   
       $options = array(
           'cluster' => env('PUSHER_APP_CLUSTER'),
           'encrypted' => true
       );
   
       $pusher = new Pusher(
           env('PUSHER_APP_KEY'),
           env('PUSHER_APP_SECRET'),
           env('PUSHER_APP_ID'),
           $options
       );
           
       $pusher->trigger('article-channel', 'App\\Events\\SendMessage', $data);
           
       $comment = new Comment();
       $comment->user_id = $userId;
       $comment->save();
   }
   ```

   ```php
   //新增PusherNotificationController，在使用event執行App\Events\SendMessage執行推播
   public function notification()
   {
       $options = array(
           'cluster' => env('PUSHER_APP_CLUSTER'),
           'encrypted' => true
       );
   
       $pusher = new Pusher(
           env('PUSHER_APP_KEY'),
   		env('PUSHER_APP_SECRET'),
   		env('PUSHER_APP_ID'),
           $options
       );
   
       $title = $article->title;
       $id = $article->id;
       $sendNotice = $article->send_notice;
   
       if($sendNotice == 'Y'){
           foreach (\App\User::cursor() as $user) {
               $data['message'] = '您有一篇新訊息【' . $title. '】';
               $data['user'] = $user;
               $pusher->trigger('article-channel', 'App\\Events\\SendMessage', $data);
           };
       }
   }
   ```

5. **新增排呈**

   ```php
   在app/console/Kernel.php，每天早上9點確認有沒有文章，今天要上線發通知給user
   protected function schedule(Schedule $schedule)
   {
      $schedule->call(function () {
          $controller = new PusherNotificationController();
          $controller->notification();
      })->dailyAt('09:00');
   }
   ```

6. **event class建立建構值**

   ```php
   class AddArticles
   {
   
      ...
   
       public $user;
       public $title;
       public $articlesId;
       public $status;
   
       public function __construct($user, $title, $articlesId, $status)
       {
           $this->user = $user;
           $this->title = $title;
           $this->articlesId = $articlesId;
           $this->status = 'addArticle';
       }
       
       ...
       
       public function broadcastOn()
       {
           return new PrivateChannel('channel-name');
       }
    }
   ```

   ```php
   class AddComment
   {
   
      ...
   
       public $user;
       public $title;
       public $articlesId;
       public $status;
   
       public function __construct($user, $title, $articlesId, $status)
       {
           $this->user = $user;
           $this->title = $title;
           $this->articlesId = $articlesId;
           $this->status = 'addComment';
       }
       
       ...
       
       public function broadcastOn()
       {
           return new PrivateChannel('channel-name');
       }
    }
   ```

   ```php
   class DeleteArticles
   {
   
      ...
   
       public $user;
       public $title;
       public $articlesId;
       public $status;
   
       public function __construct($user, $title, $articlesId, $status)
       {
           $this->user = $user;
           $this->title = $title;
           $this->articlesId = $articlesId;
           $this->status = 'deleteArticle';
       }
       
       ...
       
       public function broadcastOn()
       {
           return new PrivateChannel('channel-name');
       }
    }
   ```

   ```php
   class SendMessage implements ShouldBroadcast
   {
       ...
           
       public function broadcastOn()
       {
           return ['article-channel'];
       }
     
       public function broadcastAs()
       {
           return 'SeedMessage';
       }
   }
   ```

7. **Listeners 建立事件的內容**

   ```php
   class SendArticlesUser
   {
       public function handle($event)
       {
           Notification::send($event->user, new NewNotification($event->user, $event->title, $event->articlesId, $event->status));
       }
   }
   ```

8. **建立Blade畫面**

   ```html
   //articles.blade.php
   <div class="card-header">
       通知列表
       <input type="button" class="btn btn-primary" name="readAll" value="已閱讀全部"
                                               onCLick="readArticles(this, '')" />
   </div>
   <div id="notificationRaw">
       @foreach ($notifications as $key => $notification)
       	@if($notification['notThreeDay'])
       	<div class="row" name="notification">
                 <div class="col-8">
                     <input type="button" class="list-group-item list-group-item-action" value="您有一篇新訊息【{{ $notification['title'] }}】" 
                          @if ($notification['status'] != 'delete')
    						onclick="showArticleContent('{{ $notification['articlesId'] }}', '{{ $notification['id'] }}', '{{ $notification['read'] ? 'Y' : 'N' }}')"
                          @endif
                      />
                  </div>
                  <div class="col-4">
                      <input type="button" class="btn btn-primary" name="read" value="已閱讀" onCLick="readArticles(this, '{{ $notification['id'] }}')" {{ $notification['read'] ? 'disabled' : '' }} />
                  </div>
                                           </div>
                                       @endif
   								@endforeach
                                   </div>
                                   <input type="button" id="moreArticles" name="moreArticles" class="btn btn-primary" style="margin-top: 10px;" value="更多" onClick="showNotification()">
                               </div>
                               <div class="form-group">
   								<div class="card-header">
   									文章列表
   								</div>
   								@foreach ($articles as $key => $article)
                                       <div class="row">
                                           <div class="col-8">
                                               <input type="button" class="list-group-item list-group-item-action" value="{{ $article->title }}" onclick="showArticleContent('{{ $article->id }}', null, null)" />
                                           </div>
                                           @if($article->author_id == $userId)
                                               <div class="col-4">
                                                   <input type="button" class="btn btn-primary" name="read" value="刪除" onClick="deleteArticles(this, {{ $article->id }})"/>
                                               </div>
                                           @endif
                                       </div>
                                   @endforeach
                               </div>
   ```

   ```html
   //add.blade.php
   <html>
   
   <head>
       <meta name="csrf-token" content="{{ csrf_token() }}">
   </head>
   <body>
       <div class="container">
           <div id="app" class="justify-content-center align-items-center">
               <div class="row" style="margin-bottom: 60px;">
                   <div class="col">
                       <h2 id="title" class="text-center font-weight-bold" style="margin-bottom:20px;">新增文章</h2>
                       <div class="card">
                           <div class="card-body">
                               <form id="save" action="/addArticles" method="POST">
                                   {{ csrf_field() }}
                                   <div class="form-group">
                                       <label for="InputTitle">標題</label>
                                       <input type="text" class="form-control" id="InputTitle" name="InputTitle" value=" ">
                                   </div>
                                   <div class="form-group">
                                       <label for="InputContent">內容</label>
                                       <textarea  type="text" class="form-control" id="InputContent" name="InputContent" maxlength="500"></textarea>
                                   </div>
                                   <div class="form-group">
                                       <label for="onlineDate">上限日期</label>
                                       <input type="text" class="form-control" id="onlineDate" name="onlineDate" data-provide="datepicker">
                                   </div>
                                   
                               <form>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </body>
   
   </html>
   ```

   ```html
   //comment.blade.php
   <html>
   
   <head>
       <meta name="csrf-token" content="{{ csrf_token() }}">
   </head>
   <body>
       <div class="container">
           <div id="app" class="justify-content-center align-items-center">
               <div class="row" style="margin-bottom: 60px;">
                       <div class="card">
                           <div class="card-body">
                               <form id="save" action="/addComment" method="POST">
                                   {{ csrf_field() }}
                                   <div class="form-group">
                                       <label for="InputAuthorName">作者</label>
                                       <input type="text" class="form-control" id="InputAuthorName" name="InputAuthorName" value="{{ $authorName }}" readonly>
                                   </div>
                                   <div class="form-group">
                                       <label for="InputUserName">留言者</label>
                                       <input  type="text" class="form-control" id="InputUserName" name="InputUserName" value="{{ $userName }}" readonly>
                                   </div>
                                   <div class="form-group">
                                       <label for="InputComment">留言內容</label>
                                       <textarea  type="text" class="form-control" id="InputComment" name="InputComment" maxlength="50"></textarea>
                                   </div>
                                   </div>
                               <form>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   
   </body>
   
   </html>
   ```

   ```html
   //edit.blade.php
   <html>
   
   <head>
       <meta name="csrf-token" content="{{ csrf_token() }}">
   </head>
   <body>
       <div class="container">
           
                               <div class="form-group">
                                   <div class="card-header">
                                       留言列表
                                   </div>
                                   @foreach ($comment as $key => $value)
                                   <div class="card">
                                       <div class="card-body">
                                           <h5 class="card-title">{{ $value->name }}</h5>
                                           <p class="card-text">{{ $value->text }}</p>
                                       </div>
                                   </div>
                                   @endforeach
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
               
           </div>
       </div>
   ```

   laravel broadcast可以用pusher或Redis，必須要用laravel echo在js裡，觸發Event事來接收推播資料，Event事件必須要用ShouldBroadcast，來標記事件要做推播。Event事件會有`broadcastOn()`來告設定推播送到哪個channel。

   範例中執行route的send，在Controller做發送推播的Event事件，確認要發通知的文章，上線日期是不是今天，如果是就做發送推播，當發送過之後，pusher或Redis的channel有收到資料，這時前台會自動收到channel的推播資料後做解析，在把通知內容顯示在畫面上。

   前台收到channel的推播資料，會在console.log顯示傳過來的資料

   ```javascript
   Pusher :  : ["Event recd",{"event":"App\\Events\\SendMessage","channel":"article-channel","data":{"message":"您有一篇新訊息【新文章:11111】","user":{"id":1,"name":"測試人","email":"test@example.com","email_verified_at":null,"created_at":"2021-07-30 23:46:06","updated_at":"2021-07-30 23:46:06"}}}]
   ```

   我們可以拿data的message，顯示在畫面上

   

   

#### 問題

- 發通知時使用者太多，執行時間過長會顯示【Maximum execution time of 60 seconds exceeded when try to open phpmyadmin】

  可以用set_time_limit()，來設定執行時間


參考資料：

- https://ithelp.ithome.com.tw/articles/10231475?sc=rss.qu
- https://laravel.com/docs/6.x/notifications
- https://www.youtube.com/watch?v=Uj0jIOHvNYE&t=50s
- https://www.itread01.com/content/1544922730.html
- https://tn710617.github.io/zh-tw/laravel-digging-deeper-notifications/
- https://www.twblogs.net/a/5cc07ef7bd9eee3aed78659f
- https://www.programmersought.com/article/44691291904/
- http://yhhuang1966.blogspot.com/2017/11/xampp.html

- https://ithelp.ithome.com.tw/articles/10196486
- https://www.saashub.com/compare-pusher-vs-redis
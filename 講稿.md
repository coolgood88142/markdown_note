### 文章通知

1. 介紹

   - laracvel notification是一個發送通知的類別，可以設定很多種傳輸，例如：email、database、推播等等，可以用via()設定多個傳輸方式

   - laravel broadcast是laravel的推播系統，利用兩種第三方平台pusher、redis，利用事件將推播資料，傳送到服務的channel

   - laravel echo是將pusher、redis，在js接收channel傳過來的資料，並且將資料顯示在畫面上，做到即時通知的功能

   - laravel echo與boradcast的關係

     laravel echo是在前端接收channel傳過來的資料，boradcast則是透過事件發送推播資料，一個發送推播資料，另一個接收推播資料

   - pusher

     pusher是第三方平台服務，是將推播資料從server端傳資料給client端，pusher則是當中介層的角色，收到server端傳過來的資料後，由pusher的channel發送到client端。

   - Redis

     Redis是一個能夠快速佔存的資料庫，可以快速拿到資料，這些資料可以做database、cache，在系統上可以不用再花時間拿資料，減少對資料庫的資源

2. 流程圖

   - 新增文章

     在點選新增文章按鈕後，顯示編輯畫面，在輸入完資料做儲存，這時會新增notification的資料到table

   - 新增文章發通知

     系統上設定早上9點執行排呈，會先查詢今天為上線日期，有要發通知的文章，組訊息的內容，在用event發送通知給所有的user

   - 刪除文章

     點選刪除按鈕後，系統會移除文章資料，並且發通知給所有的user，文章已經刪除了

   - 新增留言

     點選新增留言按鈕後，顯示編輯畫面，在輸入完資料做儲存，這時系統會發通知，給作者與留言過這篇文章的user

   - 閱讀文章

     點選文章後，顯示文章內容與文章的留言資訊

   - 已閱讀通知

     點選已閱讀按鈕後，系統會先查詢這則通知的資料，在更新通知的read_at欄位資料

   - 已閱讀全部

     點選已閱讀全部後，系統會查詢當前user所有的通知資料，在更新全部通知的read_at欄位資料

   - 點選通知訊息

     點選訊息後，系統會先查詢這則通知的資料，在更新通知的read_at欄位資料

   - 發通知的系統流程

     執行發通知的事件後，在由listeners的handle()，執行notification的send()，做發送通知資料，這時notificaiton table會新增資料

   - broadcast的系統流程

     先建立發送推播的資料，透過event發送到指定的channel，將資料送到pusher或redis

   - laravel-echo-server

     先確認server有沒有啟動，沒啟動就下指令`laravel-echo-server start`，啟動時會接收socket.io的資料，並且把資料送到前端，前端會有laravel echo接收資料，並且做即時通知的功能

   - Redis發送推播資料

     建立發送推播的資料，socket.io會透過laravel-echo-server，把資料送到前端，laravel echo接收資料後，做即時通知

   - pusher發送推播資料

     建立發送推播的資料，發送到指定的channel，pusher的channel收到之後，會把資料到前端，laravel echo接收資料後，做即時通知

3. 註冊pusher帳號

   - 先到官網註冊完之後，進行登入，在建立channel，輸入channel名稱，選擇使用jquery與laravel來做發送推播通知。

4. 安裝pusher

   - 下composer require pusher/pusher-php-server 指令，裝完之後修改env檔案內容，設定pusher的相關資料
   - 在config的broadcast，新增options

5. 安裝Redis套件

   - 下composer require predis/predis指令，裝完之後修改env檔案內容，設定redis的資料

6. 安裝socket.io

   - socket.io是一個即時通知javascript函式庫，透過server端與client之間建立連線，可以即時的傳送資料給對方。
   - 但是socket.io需要依賴其他即時通知套件，才可以發送服務
   - 下npm install --save socket.io-client 指令 進行安裝

7. 安裝laravel-echo-server

   - laravel-echo-server是用來啟動socket.io的服務
   - 下 npm install laravel-echo-server指令
   - 在下 laravel-echo-server init來產生json檔
   - 在下 laravel-echo-server start會啟動服務

8. 安裝laravel echo與pusher.js

   - 下 npm install --save laravel-echo pusher-js 指令 進行安裝
   - 裝完之後，在resources/js/bootstrap.js裡，新增laravel echo的設定
   - laravel echo是一個javascript的函式庫，用來監聽頻道
   - window.Echo是指在任一個js檔案哩，可以Echo變數都是指laravel-echo
   - 使用socket.io-client套件，必須透過laravel-echo-server啟動服務
   - socket.io-client需要用window echo來設定哪個port
   - js範例中 Pusher.logToConsole = true是只要在console.log 顯示pusher資訊，接下來建立pusher物件
   - 接收pusher平台上的article-channel頻道
   - Redis接收從laravel-echo-server的socket.io，傳過來的推播資料

9. 如果有兩個channel的話，好處在哪? 有什麼情境

   - A資料是傳個人資料驗證 B資料是個人email通知

     可以利用兩種資料，分別在不同的功能，收到之後，做出不同的回應

10. 實做laravel

    - 在config的app.php有個provider，新增App\Providers\BroadcastServiceProvider
    - 建立Events與Listeners，app/Providers/EventServiceProvider.php，新增下面這幾行程式碼，並且執行php artisan event:generate
    - 在下php artisan make:notification NewNotification，來新增notification，接著在User model補上use Notifiable，才可以拿到notification的table資料

11. 建立Events

    - 執行下面這兩行指定，建立SendMessage和RedisMessage，還在補上implements ShouldBroadcast，要用這兩個event做推播

12. controller觸發事件

    - 顯示文章列表，使用目前登入的user，來查詢有多個通知、文章、頻道
    - 新增文章是依照標題、內容、作者id、上線日期、是否要發通知，將資料寫入DB，在新增notification的table資料，會利用排呈，來查詢今天為上線日期，有要發通知的文章，有的話就發送推播資料
    - 閱讀通知有分成單個與全部，單個是指已經閱讀一則通知，全部則是閱讀全部通知，這兩個都是把notification的table資料，去更新read_at欄位來記錄閱讀時間
    - 顯示文章內容，拿到文章的相關資料後，系統會查詢文章的資料，並且顯示在畫面上
    - 刪除文章，系統會移除該篇文章的資料後，並且發送通知給所有的user，通知文章已經被刪除了
    - 新增留言，系統會新增留言資料之後，發送通知給作者與留言過這篇文章的user
    - 新增頻道，需要多篇文章組成一個頻道，將資料寫DB，並且發送通知給所有的的user，有新頻道

13. 排呈

    - 在app/console/Kernel.php，schedule()，每天9點執行排呈，去查詢今天為上線日期，有要發通知的文章，有的話就發送通知

14. event

    - 新增文章、刪除文章、新增留言、新增頻道，這4個各別新增event，還有pusher與Redis的發送頻道的event

15. Listeners 發送給Notification

    - 在handle() 發送那些資料給Notification

### 如何跟pm溝通、談需求

1. 簡介

   - 工程師如何與PM溝通、談需求?

     以工程師的角度，往往會認為PM跟客戶談的需求很難達成，但是又要PM很難解釋，這也是為什麼容易聽到工程師會跟PM抱怨

   - 溝通技巧

     - 情緒管理：在跟PM講話前，調整好情緒，避免影響到思緒
     - 邏輯清楚：先想清楚產品的架構，才不會跟PM討論時怯場
     - 明確的目標：跟PM討論時，明確的講出客戶需求
     - 學會聆聽：尊重PM，聽懂PM的想法
     - 真實性：溝通時不要誇大，會讓PM覺得我講的話很浮誇，無法說服PM
     - 問對問題：先搞清楚PM問的問題，反推回去，為什麼會問這個問題
     - 同理心：在回答問題前，先站在PM角度想
     - 合適音調：在對話時其情緒上會有緊張或激動，都應該用平穩的音調講話
     - 回覆前思考：回覆時用婉轉的方式，講出重要訊息

2. 情境題

   - PM一直問白癡問題怎麼辦?

     例如：PM問我，早上客戶的問題解決了嗎?

     ​	跟PM說明，預計什麼時後完成，等等會跟客戶聯絡

   - 客戶想要的需求，對產品的幫助在哪裡? 發現對產品沒有幫助，要怎麼回絕PM?

     例如：PM說客戶在送出車輛資料後，會什麼不能自行更改

     ​	確認客戶需求的目的是什麼? 如果發現對產品沒有幫助，回絕PM驗證對產品沒有幫助，並且拿出文件說	當初談需求時沒有，只有主管才有權限才可以更改

   - PM只當傳聲筒，問題都不了解就丟過來，給工程師處理，結果發現根本不是問題

     例如：PM說客戶在新增資料時，檔案目錄會多一個資料夾

     ​	跟PM說明，使用者在新增資料時，會有夾帶附件的情況，資料夾是用來存放附件用的

   - 客戶反應的問題，PM都不提供詳細的情況描述

     例如：PM說客戶反應系統上，在驗證資料產生空白畫面

     ​	問PM客戶是在哪個時間發生? 在系統上的哪個功能? 怎麼操作的? 驗證身分的自然人憑證有沒有到期? 	或者是讀卡機沒讀到卡片?

     ​	如果PM不知道，請他跟客戶確認完這些問題，在協助客戶解決系統上的錯誤 

   - 自己想4個情境，自己有遇過的情況

     - PM一直遵從客戶的意思，什麼都想要新增功能

       例如：PM說客戶反應，想要在產品上新增功能

       ​	問PM為什麼會想要新增? PM回覆我之後，我評估之後認為，對產品上沒有影響，但是總不可能要	白做工吧。

       ​	跟PM說明後，詢問主管看看，是否要將此項目列到增修案，可以跟客戶談。

       ​	如果對產品有影響，回絕PM驗證對產品沒有幫助。

     - PM不確認好問題，就詢問我

       例如：PM說客戶在上傳檔案沒反應，要我協助處理

       ​	問PM是在哪個時間點? 是否有畫面可以提供? 客戶上傳哪些檔案?

       ​	跟PM說明後，請PM跟客戶詢問，在協助客戶處理問題。

     - PM說客戶要調整資料

       例如：問PM客戶為什麼要調整資料? 主管有同意嗎? 

       ​	評估調整資料後，會不會對產品有影響，如果有的話，確認有沒有別的方法，可以改善。

       ​	主管同意的話，請PM跟客戶說調整資料完成後，在回覆客戶。

     - PM問我客戶的怎麼在系統上操作，才會有資料

       例如：PM對產品不熟，想要問整個操作流程

       ​	回覆PM依照不同的使用者，個別說明有不同種的情境

3. 溝通SOP

   - 新增功能的溝通SOP

     PM要求我完成報表功能，PM說明原因後，評估是否需要實做報表功能，跟PM說明可以用查詢方式來顯示資料就好，如果要做的話要額外花時間

   - bug的溝通SOP

     PM說客戶反應在系統上傳文件顯示錯誤，詢問PM是在哪個時間點? 怎麼操作系統才顯示錯誤?? 詢問PM知不知道原因，如果PM不知道原因請他跟客戶確認，在評估實做時間後跟PM回報

   - 提前完成專案的溝通SOP

     PM說客戶希望這個專案能在下禮拜完成，詢問PM提前完成專案的原因，如果PM不知道原因，請他跟客戶確認，評估完成時間跟PM回報

   - 系統優化的溝通SOP

     PM說客戶反應在查詢資料時很慢，詢問PM是在哪個時間點? 查詢多久? 哪個查詢作業? 如果PM不知道原因，請他跟客戶確認後，在評估要怎麼調整查詢時間才會快

   - 調整資料的溝通SOP

     PM說客戶想要調整資料，問PM為什麼客戶要調整資料，回覆PM客戶應該，在系統上操作去調整資料，跟PM說明讓客戶在系統調整資料的步驟

4. 如何與工作同事順利溝通?

   - 先確認要溝通的事項，在溝通時要明確的講出，項目的目標是什麼，為什麼會這樣做，客戶又會怎麼操作
   - 聆聽同事的想法，做出最好的決定
   - 在溝通前調整好自己的情緒

5. 結論

   PM對於預算、時間、系統範圍極為重要，在跟客戶訪談過程，都要考慮這些因素，才能讓案子談成，也要跟工程師討論出，依照客戶需求確保符合預算與時間，來完成案子。


### mysql query優化效能

1. 優化查詢

   可以用WHERE、JOIN、ORDER BY 和GROUP BY，針對某個欄位做查詢

2. 盡可能不使用函式

   有建立索引值的情況下，使用函式的話就不會用索引做查詢，會增加查詢時間

3. select避免使用不必要查詢欄位

   不要使用select * ，最好是能指定欄位，才可以快速找到欄位資料，如果有10萬筆資料，因為有多餘的欄位，在查詢時時間會過長

4. 盡可能不使用DISTINCT和UNION

   DISTINCT和UNION，在使用時會導致不必要的排序和 SQL 執行速度減慢

5. 盡可能用INNOR JOIN，不要用LEFT JOIN或RIGHT JOIN

   使用外部連接時，會讓效能會很差，還會限制 MySQL 查詢選項，導致 SQL 語句執行速度變慢。

6. 避免在 where 子句中對欄位進行 null 值判斷

   如果使用索引值的話，SQL不會優先從索引值尋找，會直接找欄位值

   最好的方式是直接搜尋欄位的預設值

7. 分頁查詢

   查詢時最好可以限制第N筆至第N筆的資料，而不是用limit

8. union all盡量代替union

   union all是合併後在進行過濾，會影像到排序，增加CPU運算，消耗大量資源及延遲，如果用union是會直接過濾

9. 使用連接（JOIN）來代替子查詢(Sub-Queries)

   如果想要額外查詢別的table欄位資料，盡量不使用join，可以額外組子查詢，這樣不會再額外去拿join的table資料

10. 使用聯合(UNION)來代替手動創建的臨時表

    union是一個臨時用多個table組成的查詢表，跟join的差異是union會顯示全部有重複的欄位資料，join只會顯示指定欄位資料

11. 使用index查詢

    可以用查詢索引名稱，能快速找到資料

    在下SQL的時候，用index搜尋資料


## 實做文章通知

除了使用Email發送，laravel可以用database、推播、SMS 、Slack做通知。

laravel是用Notifiable做發送，發送方式可分兩種

### Notifiable Trait

發送通知用Notifiable Trait，將每個通知都用一個class做通知，建立一個Notifications的class，用`notify()`或`facade()`

- notify：執行用model去接收通知，例如：user model接收`InvoicePaid()`

  ```php
  class User extends Authenticatable
  {
      use Notifiable;
  }
  ```

  ```php
  $user->notify(new InvoicePaid($invoice));
  ```

- facade：用send做發送，例如：user model與`InvoicePaid()`發送

  ```php
  Notification::send($users, new InvoicePaid($invoice));
  ```

#### 指定傳出管道

每個通知有`via()`可以決定使用哪個傳出管道`mail`、`database`、`broadcast`、`nexmo`、`slack`

```php
public function via($notifiable)
{
    return $notifiable->prefers_sms ? ['nexmo'] : ['mail', 'database'];
}
```

#### 排隊通知

要用ShouldQueue和Queueable，當系統偵測到有ShouldQueue會自動排隊做通知

```php
class InvoicePaid extends Notification implements ShouldQueue
{
    use Queueable;

    // ...
}
```

如果想要用延遲通知，要使用`delay`，例如：設定10分鐘後在傳送

```php
$when = Carbon::now()->addMinutes(10);

$user->notify((new InvoicePaid($invoice))->delay($when));
```

#### EMail

使用Email做發送訊息

```php
public function toMail($notifiable)
{
    $url = url('/invoice/'.$this->invoice->id);

    return (new MailMessage)
                ->greeting('Hello!')
                ->line('One of your invoices has been paid!')
                ->action('View Invoice', $url)
                ->line('Thank you for using our application!');
}
```

在寄信之前要在config/app.php，設定name(要確認為什麼官網要這樣設定)



Markdowm



Database



Broadcast



SMS



Slack



#### 通知事件

以下範例為用新增一篇文章時，通知user有新的文章可以閱讀

流程圖

![mail](C:\xampp\htdocs\markdown_note\assets\images\notice1.png)

![mail2](C:\xampp\htdocs\markdown_note\assets\images\notice2.png)

1. **建立事件與監聽的class做關聯**

   在app/Providers/EventServiceProvider.php，例如：App\Events\Articles.php與App\Listeners\SendArticlesUser.php

   ```php
    protected $listen = [
           'App\Events\AddArticles' => [
               'App\Listeners\SendArticlesUser',
           ],
   ]
   ```

   執行指令建立

   ```bash
   php artisan event:generate
   ```

   event:generate是可以將make:event和make:listeners做連接，自動建立Articles、SendArticlesUser

   執行建立notifition

   ```bash
   php artisan make:notification NewNotification
   ```

2. **controller觸發事件**

   顯示文章列表

   ```php
   public function showAritcles(Request $request)
       {   
       	//拿到目前登入的user id
           $id = Auth::id();
           //取得目前登入的使用者物件
           $user = \App\User::where('id', '=', $id)->first();
           //取得所有文章資料
           $articles = Articles::orderBy('id')->get();
       	//建立目前的時間
           $datetime = Carbon::now()->setTimezone('Asia/Taipei')->toDateTimeString();
           //組所有的資料，並且傳到頁面上呈現
       	$data = [
               'notifications' => $user->notifications,
               'articles' => $articles,
               'userId' => $id,
               'datetime' => $datetime
           ];
   
           return view('articles', $data);
       } 
   ```

   ```php
   新增ArticlesController，在使用event執行App\Events\Articles
   public function addArticles()
   {
       //新增一篇文章，將標題、內容、作者id新增到db裡
       $articles = new Articles();
       $articles->title = $request->InputTitle;
       $articles->content = $request->InputContent;
       $articles->author_id = $request->userId;
       $articles->save();
       $title = $articles->title;
       $id = $articles->id;
   
       //判斷新增後的title和id不為null或空白
       if($title != null && $title != '' && $id != null && $id != ''){
           //發通知給所有的使用者，顯示有一篇新文章
           event(new AddArticles(\App\User::all(), $title));
       }
   }
   ```

   ```php
   public function readArticles(Request $request)
       {
           $id = $request->id;
           $userId = $request->userId;
       	$status = 'success';
           try{
               $this->readNotifications($id, $userId);
           }catch(Exception $e){
               $status = 'error';
           }
           return $status;
       }
   
   public function readNotifications($id, $userId)
   	{
           $user = User::where('id', '=', $userId)->first();
           $data = $user->unreadNotifications;
               
           if($id != ''){
               foreach($data as $key => $value){
                   $dataId = $value->id;
                   if($dataId == $id){
                       $value->markAsRead();
                           break;
                   }
               }
           }else{
               $data->markAsRead();
           }
       }
   ```

   ```php
   public function updateArticles(Request $request)
       {
           $id = $request->id;
           $userId = $request->userId;
           $notificationId = $request->notificationId;
           $isAdd = $request->isAdd;
           $articles = Articles::where('id', '=', $id)->first();
           $user = User::where('id', '=', $articles->author_id)->first();
           $comment =  DB::table('users')
               ->select('users.name', 'comment.text')
               ->join('comment', 'users.id', '=', 'comment.user_id')
               ->where([
                   ['articles_id', '=', $id]
               ])
               ->get();
   
           //點選後直接做已閱讀
           $this->readNotifications($notificationId, $userId);
   
           return view('edit', [
               'articleId' => $id,
               'title' => $articles->title,
               'content' => $articles->content,
               'userId' => $userId,
               'userName' => $user->name,
               'comment' => $comment,
               'isAdd' => $isAdd
           ]);
       }
   ```

   ```php
   public function editArticles(Request $request)
       {
           $id = $request->id;
           $userId = $request->userId;
           $isAdd = $request->isAdd;
           $articles = Articles::where('id', '=', $id)->first();
           $user = User::where('id', '=', $articles->author_id)->first();
           $comment =  DB::table('users')
               ->select('users.name', 'comment.text')
               ->join('comment', 'users.id', '=', 'comment.user_id')
               ->where([
                   ['articles_id', '=', $id]
               ])
               ->get();
   
           return view('edit', [
               'articleId' => $id,
               'title' => $articles->title,
               'content' => $articles->content,
               'userId' => $userId,
               'userName' => $user->name,
               'comment' => $comment,
               'isAdd' => $isAdd
           ]);
       }
   ```

   

3. **event class建立建構值**

   ```php
   class AddArticles
   {
   
      ...
   
       public $user;
       public $title;
   
       public function __construct($user, $title, $articlesId, $status)
       {
           $this->user = $user;
           $this->title = $title;
           $this->articlesId = $articlesId;
           $this->status = $status;
       }
    }
   ```

4. **Listeners 建立事件的內容**

   ```php
   class SendArticlesUser
   {
       public function handle($event)
       {
           Notification::send($event->user, new NewNotification($event->user, $event->title, $event->articlesId, $event->status));
       }
   }
   ```

5. **建立Blade畫面**

   ```html
   <html>
   
   <head>
       <meta name="csrf-token" content="{{ csrf_token() }}">
   </head>
   <body>
       <div class="container">
           <div id="app" class="justify-content-center align-items-center">
               <div class="row" style="margin-bottom: 60px;">
                   <div class="col">
                       <h2 id="title" class="text-center font-weight-bold" style="margin-bottom:20px;">文章資訊</h2>
                       <div class="card">
                           <div class="card-body">
                               <div class="form-group">
                                   <div class="card-header">
                                       通知列表
                                       <input type="button" class="btn btn-primary" name="readAll" value="已閱讀全部"
                                               onCLick="readArticles(this, '')" />
   								</div>
   								@foreach ($notifications as $key => $notification)
                                       <div class="row">
                                           <div class="col-8">
                                               @if ($notification->data['status'] != 'delete')
                                                   <input type="button" class="list-group-item list-group-item-action" value="您有一篇新訊息【{{ $notification->data['title'] }}】" 
                                                       onclick="window.location.href='/updateArticles?id={{ $notification->data['articlesId'] }}&notificationId={{ $notification->id }}&userId={{ $userId }}&isAdd=N'" />
                                               @else
                                                   <input type="button" class="list-group-item list-group-item-action" value="您有一篇新訊息【{{ $notification->data['title'] }}】" />
                                               @endif
                                           </div>
                                           <div class="col-4">
                                               <input type="button" class="btn btn-primary" name="read" value="已閱讀"
                                               onCLick="readArticles(this, '{{ $notification->id }}')" {{ $notification->read() ? 'disabled' : '' }} />
                                           </div>
                                       </div>
   								@endforeach
                               </div>
                               <div class="form-group">
   								<div class="card-header">
   									文章列表
   								</div>
   								@foreach ($articles as $key => $article)
                                       <div class="row">
                                           <div class="col-8">
                                               <input type="button" class="list-group-item list-group-item-action" value="{{ $article->title }}" onclick="window.location.href='/editArticles?id={{ $article->id }}&userId={{ $userId }}&isAdd=N'" />
                                           </div>
                                           <div class="col-4">
                                               <input type="button" class="btn btn-primary" name="read" value="刪除" onClick="deleteArticles(this, {{ $article->id }})"/>
                                           </div>
                                       </div>
                                   @endforeach
                               </div>
                               <div class="form-group">
                                   <input type="hidden" id="userId" name="userId" value="{{ $userId }}">
                                   <input type="button" class="btn btn-primary" value="新增文章" onclick="window.location.href='/add?userId={{ $userId }}'">
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
       <script src="{{mix('js/app.js')}}"></script>
   	<script src="{{mix('js/edit.js')}}"></script>
   </body>
   
   </html>
   ```

   ```html
   <html>
   
   <head>
       <meta name="csrf-token" content="{{ csrf_token() }}">
   </head>
   <body>
       <div class="container">
           <div id="app" class="justify-content-center align-items-center">
               <div class="row" style="margin-bottom: 60px;">
                   <div class="col">
                       <h2 id="title" class="text-center font-weight-bold" style="margin-bottom:20px;">文章資料</h2>
                       <div class="card">
                           <div class="card-body">
                               <form id="save" action="/queryAuthor" method="POST">
                                   {{ csrf_field() }}
                                   <div class="form-group">
                                       <label for="InputTitle">標題</label>
                                       <input type="text" class="form-control" id="InputTitle" name="InputTitle" value="{{ $title }}" readonly>
                                   </div>
                                   <div class="form-group">
                                       <label for="InputContent">內容</label>
                                       <textarea  type="text" class="form-control" id="InputContent" name="InputContent" maxlength="500" readonly>{{ $content }}</textarea>
                                   </div>
                                   <div class="form-group">
                                       <label for="InputAuthor">作者</label>
                                       <input  type="text" class="form-control" id="InputAuthor" name="InputAuthor" value="{{ $userName }}" readonly>
                                   </div>
                                   <div class="form-group">
                                       <input type="hidden" id="isAdd" name="isAdd" value="{{ $isAdd }}">
                                       <input type="button" class="btn btn-primary" id="back" name="back" value="回上一頁" onClick="window.location.href='/articles'">
                                       <input type="button" class="btn btn-primary" id="showAritcles" name="showAritcles" style="display:none;" value="回文章列表" onClick="window.location.href='/articles'">
                                       <input type="button" class="btn btn-primary" value="新增留言" onclick="window.location.href='/editComment?articleId={{ $articleId }}&userId={{ $userId }}'">
                                   </div>
                               <form>
                               <div class="form-group">
                                   <div class="card-header">
                                       留言列表
                                   </div>
                                   @foreach ($comment as $key => $value)
                                   <div class="card">
                                       <div class="card-body">
                                           <h5 class="card-title">{{ $value->name }}</h5>
                                           <p class="card-text">{{ $value->text }}</p>
                                       </div>
                                   </div>
                                   @endforeach
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
               
           </div>
       </div>
       <script src="{{mix('js/app.js')}}"></script>
       <script src="{{mix('js/edit.js')}}"></script>
       <script>
           $( document ).ready(function() {
               let isAdd = $('#isAdd').val();
               if(isAdd == 'Y'){
                   $('#back').hide();
                   $('#showAritcles').show();
               }
           });
   
           function saveArticles(){
               let InputTitle = $('#InputTitle').val();
               let InputContent = $('#InputContent').val();
               let message = '';
   
               if(InputTitle == '' || InputTitle == null){
                   message += '請輸入標題' + '<br/>';
               }
   
               if(InputContent == '' || InputContent == null){
                   message += '請輸入內容' + '<br/>';
               }
   
               if(message != ''){
                   alert(message);
               }else{
                   $('#save').submit();
               }
           }
       </script>
   </body>
   
   </html>
   ```

   

6. **建立Route**

   在routes\web.php，新增下面這行

   ```php
   Route::get('/add', 'ArticlesController@addArticles');
   
   Route::get('/add', 'ArticlesController@showAdd');
   
   Route::get('/articles', 'ArticlesController@showAritcles')->name('showAritcles');
   
   Route::post('/addArticles', 'ArticlesController@addArticles');
   
   Route::post('/readArticles', 'ArticlesController@readArticles');
   
   Route::post('/deleteArticles', 'ArticlesController@deleteArticles');
   
   Route::post('/saveArticles', 'ArticlesController@saveArticles');
   
   Route::post('/addComment', 'CommentController@addComment');
   ```



#### 問題

- 執行時間過長會顯示【Maximum execution time of 60 seconds exceeded when try to open phpmyadmin】




參考資料：

- https://ithelp.ithome.com.tw/articles/10231475?sc=rss.qu
- https://laravel.com/docs/6.x/notifications
- https://www.youtube.com/watch?v=Uj0jIOHvNYE&t=50s
- https://www.itread01.com/content/1544922730.html
- https://tn710617.github.io/zh-tw/laravel-digging-deeper-notifications/
- https://www.twblogs.net/a/5cc07ef7bd9eee3aed78659f
- https://www.programmersought.com/article/44691291904/
- http://yhhuang1966.blogspot.com/2017/11/xampp.html